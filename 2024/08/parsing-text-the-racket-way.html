<!DOCTYPE html5>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Parsing Text the Racket Way</title>
    <meta name="description" content="Have you ever needed to process some raw text and extract only parts of it? Most of the time, you can get by with some nasty regular expressions with groups, but sometimes the pattern that you're trying to process is too complicated for regular expression...">
    <meta name="author"      content="Mike Delmonaco">
    <meta name="keywords"    content="racket, macros, dsls, tutorials">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/blog/favicon.ico">
    <link rel="canonical" href="https://quasarbright.github.io/blog/2024/08/parsing-text-the-racket-way.html">
    <link rel="next" href="/blog/2024/08/computing-fibonacci-numbers-in-logarithmic-time.html">

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/blog/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/racket.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/minesweeper.css">
    <style>
      .MathJax .mi, .MathJax .mo {
        color: inherit;
      }
    </style>
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/blog/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/blog/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-xxxxx', 'auto');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
  </head>
  <body>

    <!-- A standard Twitter Bootstrap nav bar -->
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
      <div class="container">

      <a href="/blog/index.html" class="navbar-brand">Mike Delmonaco</a>

      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
              data-target="#navbar_collapse" aria-controls="navbar_collapse"
              aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbar_collapse">
          <ul class="navbar-nav mr-auto">


            <li class="nav-item dropdown">
              <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b>
              </a>

              <div class="dropdown-menu">
                <a class="dropdown-item" href="/blog/tags/algorithms.html">algorithms</a><a class="dropdown-item" href="/blog/tags/artificial-intelligence.html">artificial-intelligence</a><a class="dropdown-item" href="/blog/tags/continuations.html">continuations</a><a class="dropdown-item" href="/blog/tags/dsls.html">dsls</a><a class="dropdown-item" href="/blog/tags/dynamic-programming.html">dynamic-programming</a><a class="dropdown-item" href="/blog/tags/game.html">game</a><a class="dropdown-item" href="/blog/tags/JavaScript.html">JavaScript</a><a class="dropdown-item" href="/blog/tags/machine-learning.html">machine-learning</a><a class="dropdown-item" href="/blog/tags/macros.html">macros</a><a class="dropdown-item" href="/blog/tags/math.html">math</a><a class="dropdown-item" href="/blog/tags/programming-languages.html">programming-languages</a><a class="dropdown-item" href="/blog/tags/projects.html">projects</a><a class="dropdown-item" href="/blog/tags/racket.html">racket</a><a class="dropdown-item" href="/blog/tags/tutorials.html">tutorials</a><a class="dropdown-item" href="/blog/tags/understand-and-implement.html">understand-and-implement</a>
              </div>
            </li>

            <li>
              <a class="nav-link" href="/blog/index.html">Home</a>
            </li> 

            <li>
              <a class="nav-link" href="/blog/About.html">About</a>
            </li> 

            <li class="nav-item">
              <a class="nav-link" href="/blog/feeds/all.atom.xml">Atom</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/blog/feeds/all.rss.xml">RSS</a>
            </li>
          </ul>
      </div>

      </div>
    </nav>


    <div class="container">
      <div class="row">

        <!-- Main column -->
        <div id="content" class="col-md-12">





          <article>
  <header>
    <h1>Parsing Text the Racket Way</h1>
    <p class='date-and-tags'>
<time datetime="2024-08-24" pubdate="true">2024-08-24</time> :: <span class="tags"><a href="/blog/tags/racket.html">racket</a>, <a href="/blog/tags/macros.html">macros</a>, <a href="/blog/tags/dsls.html">dsls</a>, <a href="/blog/tags/tutorials.html">tutorials</a></span></p>
    <p class='authors'>By: <span class="authors">Mike Delmonaco</span></p>
  </header>

<p>Have you ever needed to process some raw text and extract only parts of it? Most of the time, you can get by with some nasty regular expressions with groups, but sometimes the pattern that you&rsquo;re trying to process is too complicated for regular expressions. That&rsquo;s what parsers are good for, and they&rsquo;re also the first step in an interpreter/compiler!</p>

<p>In this post, we&rsquo;ll discover parsers and create a domain-specific language for creating parsers in Racket.</p>
<!--more-->

<p>A parser is conceptually a function from a string to some other data structure. It reads in text and processes it into some data representation. For example, a JSON parser takes in JSON text and processes it into lists and maps of numbers, booleans, strings, and nulls. If you&rsquo;ve ever tried to write something like a parser yourself, you probably used regular expressions. But regular expressions can quickly become unwieldy as the "language" of text you&rsquo;re processing becomes more complicated. And they&rsquo;re not re-usable. You can&rsquo;t easily reference one regular expression from another. Let&rsquo;s start by making our own version of regular expressions that are less compact, but easier to read and more re-usable.</p>

<p>Let&rsquo;s start out by thinking how this is going to work. We want a function that takes in a regular expression and a string and tells us whether the string matches the pattern specified by the regular expression. For example:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"baz"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">"foobarbazbarbar"</span><span class="RktPn">)</span></td></tr></tbody></table></div>

<p>Here is the grammar for our little regular expression language:</p>

<p></p>

<table cellpadding="0" cellspacing="0">
 <tbody>
  <tr>
   <td align="right" valign="baseline"><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">regexp</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">=</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktVar">regexp</span><span class="RktPn">)</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktVar">regexp</span><span class="hspace">&nbsp;</span><span class="RktVar">regexp</span><span class="RktPn">)</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktVar">regexp</span><span class="hspace">&nbsp;</span><span class="RktVar">regexp</span><span class="RktPn">)</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVar">string-expr</span><span class="RktPn">)</span></td></tr></tbody></table>

<p><span class="RktSym">repeat</span> matches zero or more occurrences of the sub-pattern, <span class="RktSym">alt</span> matches if either sub-pattern matches, <span class="RktSym">seq</span> matches if the first sub-pattern matches and the second sub-pattern matches the text <span class="emph">after</span> the text matched by the first one, and <span class="RktSym">text</span> matches the exact string passed to it.</p>

<p>In order to support <span class="RktSym">seq</span> and <span class="RktSym">repeat</span>, we&rsquo;ll need some way to match a pattern on the beginning of a string and not expect it to match the entire string. Then, if it matched, we&rsquo;re going to need to know where the matched text ends so we can keep going on the rest of the text.</p>

<p>To keep track of where we are in the target string, we&rsquo;ll use an index:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define-struct.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._struct%29%29">struct</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">index</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">#:transparent</span><span class="RktPn">)</span></td></tr></tbody></table></div>

<p>The text will be a string, and the index will be a natural number indicating where in the string we should start looking as we match text. As we go through the string, we&rsquo;ll increase the index.</p>

<p>Next, we have to figure out how we&rsquo;re going to represent regular expressions. What does a regular expression do? It should be able to take in a stream and either match text or fail. We&rsquo;ll represent matching the text by returning a new stream advanced to after the match, and failure as returning <span class="RktVal">#f</span>. So a regular expression is a function which takes in a stream and either returns a stream or <span class="RktVal">#f</span>. Let&rsquo;s start implementing!</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">expected-str</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/match.html#%28form._%28%28lib._racket%2Fmatch..rkt%29._match%29%29">match</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">index</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">index^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._%2B%29%29">+</a></span><span class="hspace">&nbsp;</span><span class="RktSym">index</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string-length%29%29">string-length</a></span><span class="hspace">&nbsp;</span><span class="RktSym">expected-str</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._and%29%29">and</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._~3c~3d%29%29">&lt;=</a></span><span class="hspace">&nbsp;</span><span class="RktSym">index^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string-length%29%29">string-length</a></span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string~3d~3f%29%29">string=?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">expected-str</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._substring%29%29">substring</a></span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">index</span><span class="hspace">&nbsp;</span><span class="RktSym">index^</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">index^</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "foo" 3)</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"foobar"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "foobar" 3)</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"fo"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">""</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"hello"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"aafooaa"</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "aafooaa" 5)</span></p></td></tr></tbody></table></div>

<p>We make sure the <span class="emph">next</span> text in the stream (starting at <span class="RktSym">index</span>) is <span class="RktSym">expected-str</span> and if it is, we advance the stream past that text. Otherwise, we return <span class="RktVal">#f</span>. We also make sure there is enough text left in the stream to even match the text to avoid an index out of bounds error.</p>

<p>Let&rsquo;s do <span class="RktSym">seq</span> now:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktSym">re1</span><span class="hspace">&nbsp;</span><span class="RktSym">re2</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">re1</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._and%29%29">and</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">re2</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"foobar"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "foobar" 6)</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"foobarbaz"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "foobarbaz" 6)</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"fooxxx"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"xxxbar"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr></tbody></table></div>

<p>We run <span class="RktSym">re1</span> on the initial input stream and if it succeeds, we run <span class="RktSym">re2</span> on the advanced input stream.</p>

<p>Now <span class="RktSym">alt</span>:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">re1</span><span class="hspace">&nbsp;</span><span class="RktSym">re2</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._or%29%29">or</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">re1</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">re2</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "foo" 3)</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "bar" 3)</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"hello"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr></tbody></table></div>

<p>Pretty straightforward translation! We try the first pattern and if it fails, we try the second on the same stream, from the same index that we started with (since there is no mutation, it doesn&rsquo;t matter if <span class="RktSym">re1</span> "advanced" the stream before failing).</p>

<p>Now, let&rsquo;s wrap it up with <span class="RktSym">repeat</span>:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktSym">re</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">re</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28quote._~23~25kernel%29._if%29%29">if</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktSym">re</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"ha"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"ha"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "ha" 2)</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"ha"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">""</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "" 0)</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"ha"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"hahahahahahaha"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "hahahahahahaha" 14)</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"ha"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"hahahahahahaha very funny"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(stream "hahahahahahaha very funny" 14)</span></p></td></tr></tbody></table></div>

<p>If <span class="RktSym">re</span> succeeds, we recur. Otherwise, we succeed anyway with the original input stream. Remember, we succeed on zero or more matches, so if the sub-pattern fails, the <span class="RktSym">repeat</span> still succeeds.</p>

<p>It&rsquo;s important to note that this is a greedy implementation of <span class="RktSym">repeat</span> that will cause some patterns to fail when they shouldn&rsquo;t:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"a"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"a"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"aaa"</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr></tbody></table></div>

<p>This should theoretically succeed with the <span class="RktPn">(</span><span class="RktSym">repeat</span><span class="stt"> </span><span class="RktPn">(</span><span class="RktSym">text</span><span class="stt"> </span><span class="RktVal">"a"</span><span class="RktPn">)</span><span class="RktPn">)</span> matching the first two <span class="RktVal">"a"</span>s and the second <span class="RktPn">(</span><span class="RktSym">text</span><span class="stt"> </span><span class="RktVal">"a"</span><span class="RktPn">)</span> matching the third, but since the repetition succeeds greedily matching the whole string, the second text pattern fails since the stream ended. We could implement backtracking matching, but to keep things simple, we&rsquo;ll just be mindful of this behavior and continue on.</p>

<p>To provide our desired interface, let&rsquo;s implement <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span>:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">re</span><span class="hspace">&nbsp;</span><span class="RktSym">s</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">re</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktSym">s</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._and%29%29">and</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._~3d%29%29">=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string-length%29%29">string-length</a></span><span class="hspace">&nbsp;</span><span class="RktSym">s</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">stream-index</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#t</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"foobar"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr></tbody></table></div>

<p>We add that index condition to make sure the pattern matches the entire string, not just a prefix.</p>

<p>What we have right now is less powerful than regular expressions in some ways, like the fact that we can&rsquo;t use groups to extract pieces of text. We&rsquo;ll address that soon. However, what we have is more powerful than regular expressions in other ways. For example, we can create recursive regular expressions to match patterns that are impossible to match with typical regular expressions:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">balanced-parentheses</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"("</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">balanced-parentheses</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">""</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">")"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">balanced-parentheses</span><span class="hspace">&nbsp;</span><span class="RktVal">"()"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#t</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">balanced-parentheses</span><span class="hspace">&nbsp;</span><span class="RktVal">"(())"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#t</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">balanced-parentheses</span><span class="hspace">&nbsp;</span><span class="RktVal">"(((())))"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#t</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">balanced-parentheses</span><span class="hspace">&nbsp;</span><span class="RktVal">"("</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">balanced-parentheses</span><span class="hspace">&nbsp;</span><span class="RktVal">"())"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr></tbody></table></div>

<p>That&rsquo;s impossible with typical non-recursive regular expressions. Also, that lambda may seem pointless, but if we don&rsquo;t do that, we won&rsquo;t be able to construct recursive regular expressions without going into an infinite loop. The lambda delays the recursion.</p>

<p>To avoid writing that lambda, we can make a macro:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._define-syntax-rule%29%29">define-syntax-rule</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp%29%29">regexp</a></span><span class="hspace">&nbsp;</span><span class="RktSym">re</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">re</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">balanced-parentheses</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp%29%29">regexp</a></span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"("</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">balanced-parentheses</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">""</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">")"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr></tbody></table></div>

<p>We can also re-use regular expressions and create abstractions:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parenthesized</span><span class="hspace">&nbsp;</span><span class="RktSym">re</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"("</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktSym">re</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">")"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parenthesized</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"(foo)"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#t</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">spaces</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">" "</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sexpr</span><span class="hspace">&nbsp;</span><span class="RktSym">atom</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp%29%29">regexp</a></span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">atom</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parenthesized</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sexpr</span><span class="hspace">&nbsp;</span><span class="RktSym">atom</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">spaces</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._number%29%29">number</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"0"</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"1"</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"0"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"1"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sexpr</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._number%29%29">number</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"(1 (100 10 0) ())"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#t</span></p></td></tr></tbody></table></div>

<p>Nice! Using just these simple tools, you could make a JSON recognizer, or even a recognizer for most programming languages. I say recognizer instead of parser because all we get is a boolean, not structured data. For that, we&rsquo;ll need full-blown parsers.</p>

<p>A parser is going to be like a regular expression, except instead of just returning an input stream or <span class="RktVal">#f</span>, it can return a result with the input stream on success. It will still just return <span class="RktVal">#f</span> on failure.</p>

<p>Let&rsquo;s define a grammar for parsers:</p>

<p></p>

<table cellpadding="0" cellspacing="0">
 <tbody>
  <tr>
   <td align="right" valign="baseline"><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">parser</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">=</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktVar">string-literal</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVar">string-expr</span><span class="RktPn">)</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktVar">parser</span><span class="hspace">&nbsp;</span><span class="RktSym">...+</span><span class="RktPn">)</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktVar">parser</span><span class="hspace">&nbsp;</span><span class="RktSym">...+</span><span class="RktPn">)</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktVar">parser</span><span class="RktPn">)</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktVar">id</span><span class="hspace">&nbsp;</span><span class="RktVar">parser</span><span class="RktPn">)</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktVar">parser</span><span class="hspace">&nbsp;</span><span class="RktVar">expr</span><span class="RktPn">)</span></td></tr>
  <tr>
   <td align="right" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="center" valign="baseline">|</td>
   <td align="left" valign="baseline"><span class="stt">&nbsp;</span></td>
   <td align="left" valign="baseline"><span class="RktVar">racket-expr</span></td></tr></tbody></table>

<p><span class="RktSym">text</span> will return the matched text, string literals get converted into <span class="RktSym">text</span> parsers, <span class="RktSym">alt</span> will return the result of whichever parser succeeds, <span class="RktSym">seq</span> will return a <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._cons%29%29">cons</a></span> pair containing each sub-parser result, <span class="RktSym">repeat</span> will return a list of parse results from the sub-parser, <span class="RktSym">bind</span> binds the result of the sub-parser to a variable and returns it, and <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span> ignores the sub-parser result and returns the value of the sub-expression instead. It&rsquo;s usually used with <span class="RktSym">bind</span> to combine results of sub-parsers. The <span class="RktSym">racket-expr</span> case is for referencing defined parsers like <span class="RktSym">spaces</span> and <span class="RktSym">parenthesized</span>.</p>

<p>Here is an example:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define-struct.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._struct%29%29">struct</a></span><span class="hspace">&nbsp;</span><span class="RktSym">addition</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">#:transparent</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define-struct.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._struct%29%29">struct</a></span><span class="hspace">&nbsp;</span><span class="RktSym">multiplication</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">#:transparent</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">number-expr</span><span class="hspace">&nbsp;</span><span class="RktSym">addition-expr</span><span class="hspace">&nbsp;</span><span class="RktSym">multiplication-expr</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">number-expr</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"1"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"0"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">addition-expr</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktVal">"("</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"+"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">")"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">addition</span><span class="hspace">&nbsp;</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">multiplication-expr</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktVal">"("</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"*"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">")"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">multiplication</span><span class="hspace">&nbsp;</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym">parse</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"((1+1)*(1+1))"</span><span class="RktPn">)</span></td></tr></tbody></table></div>

<p>In this example, we define a parser for a tiny arithmetic language. We define structs for an abstract syntax tree and parse strings into our structs.</p>

<p>Since we have <span class="RktSym">bind</span>, we&rsquo;re going to need macros. And the binding structure is pretty weird here. We&rsquo;re binding a variable deep inside an expression and using it outside. It&rsquo;s sort of like <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/match.html#%28form._%28%28lib._racket%2Fmatch..rkt%29._match%29%29">match</a></span>. We&rsquo;re going to need a full-on macro compiler. In fact, our compiler will look a lot like the compiler for <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/match.html#%28form._%28%28lib._racket%2Fmatch..rkt%29._match%29%29">match</a></span> that we made in <a href="/blog/2023/10/understanding-and-implementing-pattern-matching.html">this post</a>.</p>

<p>Let&rsquo;s start by defining what we can as procedures and then add macros on top. Instead of returning either <span class="RktVal">#f</span> or an input stream, we&rsquo;re going to return a new structure containing both an input stream and a parse result on success:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define-struct.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._struct%29%29">struct</a></span><span class="hspace">&nbsp;</span><span class="RktSym">parse-result</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">value</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">#:transparent</span><span class="RktPn">)</span></td></tr></tbody></table></div>

<p>We can define <span class="RktSym">parse</span> and <span class="RktSym">text</span> as procedures:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parse</span><span class="hspace">&nbsp;</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktSym">s</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">result</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktSym">s</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/match.html#%28form._%28%28lib._racket%2Fmatch..rkt%29._match%29%29">match</a></span><span class="hspace">&nbsp;</span><span class="RktSym">result</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">parse-result</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktSym">idx^</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">value</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:when</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._~3d%29%29">=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string-length%29%29">string-length</a></span><span class="hspace">&nbsp;</span><span class="RktSym">s</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">idx^</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">value</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">expected-str</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/match.html#%28form._%28%28lib._racket%2Fmatch..rkt%29._match%29%29">match</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">index</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">index^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._%2B%29%29">+</a></span><span class="hspace">&nbsp;</span><span class="RktSym">index</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string-length%29%29">string-length</a></span><span class="hspace">&nbsp;</span><span class="RktSym">expected-str</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._and%29%29">and</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._~3c~3d%29%29">&lt;=</a></span><span class="hspace">&nbsp;</span><span class="RktSym">index^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string-length%29%29">string-length</a></span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string~3d~3f%29%29">string=?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">expected-str</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._substring%29%29">substring</a></span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">index</span><span class="hspace">&nbsp;</span><span class="RktSym">index^</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parse-result</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/streams.html#%28form._%28%28lib._racket%2Fstream..rkt%29._stream%29%29">stream</a></span><span class="hspace">&nbsp;</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">index^</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">expected-str</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">parse</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">"foo"</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">parse</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"fooooooo"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">parse</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"bar"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">#f</span></p></td></tr></tbody></table></div>

<p><span class="RktSym">parse</span> is like <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp-match~3f%29%29">regexp-match?</a></span>, but we return the result of the parse instead of a boolean.</p>

<p><span class="RktSym">text</span> is like regexp <span class="RktSym">text</span>, except we return the matched string in a <span class="RktSym">parse-result</span> with the resulting stream on success.</p>

<p>Unfortunately, we can&rsquo;t easily define runtime representations for our other parsers like <span class="RktSym">seq</span>. Due to the nature of how we&rsquo;re going to do binding, we&rsquo;re going to inline them in our compiler.</p>

<p>Let&rsquo;s write our compiler top-down:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-syntax%29%29">for-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktSym">syntax/parse</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._define-syntax-rule%29%29">define-syntax-rule</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parse-result</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-syntax%29%29">define-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktSym">compile-parse</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Parsing_Syntax.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._syntax-parser%29%29">syntax-parser</a></span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">in:id</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Parsing_Syntax.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._syntax-parse%29%29">syntax-parse</a></span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">p</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:datum-literals</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktSym">bind</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">s:string</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">compile-parse</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktSym">s</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">compile-parse-seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">compile-parse-alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">compile-parse-repeat</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">compile-parse-=&gt;</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">compile-parse-bind</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">e</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">call-with-parse-result</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">e</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">call-with-parse-result</span><span class="hspace">&nbsp;</span><span class="RktSym">result</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/match.html#%28form._%28%28lib._racket%2Fmatch..rkt%29._match%29%29">match</a></span><span class="hspace">&nbsp;</span><span class="RktSym">result</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">parse-result</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">value</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">value</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr></tbody></table></div>

<p>The <span class="RktSym">parser</span> form is like the <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/regexp.html#%28def._%28%28quote._~23~25kernel%29._regexp%29%29">regexp</a></span> form we defined before. It wraps the parser in a <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span>, but it also invokes our compiler macro.</p>

<p>Our compiler takes in a parser&rsquo;s syntax <span class="RktSym">p</span>, an identifier that the input stream is bound to, <span class="RktSym">in</span>, syntax for an <span class="RktSym">on-success</span> procedure that takes in the resulting input stream and the parse result&rsquo;s value, and syntax for an <span class="RktSym">on-fail</span> procedure which takes in zero arguments. Like our <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/match.html#%28form._%28%28lib._racket%2Fmatch..rkt%29._match%29%29">match</a></span> compiler we made in <a href="/blog/2023/10/understanding-and-implementing-pattern-matching.html">another post</a>, this compiler uses continuation-passing style with those <span class="RktSym">on-success</span> and <span class="RktSym">on-fail</span> procedures.</p>

<p>For each case, we defer to sub-compilers that we&rsquo;ll write in a moment, except for the parser reference case, which we&rsquo;ve inlined. The parser reference case treats the parser syntax as a Racket expression that produces a parser, like <span class="RktSym">parenthesized</span> or <span class="RktSym">spaces</span>.</p>

<p>Now let&rsquo;s start defining these sub-compilers:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-syntax%29%29">define-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktSym">compile-parse-seq</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax-rules%29%29">syntax-rules</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._list%29%29">list</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">p0</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse</span><span class="hspace">&nbsp;</span><span class="RktSym">p0</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^^</span><span class="hspace">&nbsp;</span><span class="RktSym">vs</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">in^^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._cons%29%29">cons</a></span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">vs</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr></tbody></table></div>

<p>To parse an empty <span class="RktSym">seq</span>, we simply succeed with an empty list. Otherwise, we run the first parser and <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._cons%29%29">cons</a></span> its result ot the results of the rest of the <span class="RktSym">seq</span>&rsquo;s results. The rest is just threading around the input stream.</p>

<p>Unlike our regular expression <span class="RktSym">seq</span>, this one can take zero or more sub-parsers, not just two.</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-syntax%29%29">define-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktSym">compile-parse-alt</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax-rules%29%29">syntax-rules</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">p0</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse</span><span class="hspace">&nbsp;</span><span class="RktSym">p0</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">on-success</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr></tbody></table></div>

<p>An empty <span class="RktSym">alt</span> fails. Otherwise, we just try each sub-parser.</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._define-syntax-rule%29%29">define-syntax-rule</a></span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse-=&gt;</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr></tbody></table></div>

<p>For <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span>, which is called a semantic action, we ignore the result of the sub-parse and just return <span class="RktSym">e</span> instead.</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._define-syntax-rule%29%29">define-syntax-rule</a></span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse-bind</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr></tbody></table></div>

<p>For <span class="RktSym">bind</span>, we bind the result to the variable name on success.</p>

<p>Here is an example expansion of a semantic action and binding so we can see how they fit together:</p>

<p></p>

<div class="SIntrapara">
 <div class="SCodeFlow">
  <table cellpadding="0" cellspacing="0" class="RktBlk">
   <tbody>
    <tr>
     <td><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string-upcase%29%29">string-upcase</a></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></div></div>

<div class="SIntrapara">becomes something like
</div>

<div class="SIntrapara">
 <div class="SCodeFlow">
  <table cellpadding="0" cellspacing="0" class="RktBlk">
   <tbody>
    <tr>
     <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">call-with-parse-result</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text-rt</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^^</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^^^</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parse-result</span><span class="hspace">&nbsp;</span><span class="RktSym">in^^^</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">in^^</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string-upcase%29%29">string-upcase</a></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">in^</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></div></div>

<p>Our compiler creates nested <span class="RktSym">on-success</span> lambdas, which is where binding happens. The resulting syntax is almost inside-out from the original, having the innermost sub-parsers on the outside executing first, as they should, and the outermost parsers on the inside executing last, on the results of the sub-parsers. That&rsquo;s how bindings inside the parser are usable in outer parts of the parser.</p>

<p>Next up is <span class="RktSym">repeat</span>, which is a little tricky because of binding. Consider this example:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">number-expr</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"1"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"0"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">array-expr</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktVal">"["</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">number-expr</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">","</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"]"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="RktPn">(</span><span class="RktSym">parse</span><span class="hspace">&nbsp;</span><span class="RktSym">array-expr</span><span class="hspace">&nbsp;</span><span class="RktVal">"[1,0,1,]"</span><span class="RktPn">)</span></td></tr></tbody></table></div>

<p>The <span class="RktSym">bind</span> is in the <span class="RktSym">repeat</span>, but its variable is used outside of the <span class="RktSym">repeat</span>. What should <span class="RktSym">n</span> be bound to outside of the <span class="RktSym">repeat</span>? This is like the syntax pattern</p>

<div class="SCodeFlow">
 <p><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">rhs</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">body</span><span class="RktPn">)</span></p></div>

<p>In that pattern, <span class="RktSym">x</span> gets bound to the list of all variables bound in the let. We&rsquo;ll do something similar, so outside of the <span class="RktSym">repeat</span>, any variable that got bound inside will end up bound to the list of values it was bound to internally. So the result of that <span class="RktSym">parse</span> should be <span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._list%29%29">list</a></span><span class="stt"> </span><span class="RktVal">1</span><span class="stt"> </span><span class="RktVal">0</span><span class="stt"> </span><span class="RktVal">1</span><span class="RktPn">)</span>.</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-syntax%29%29">for-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktSym">syntax/parse</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin-for-syntax%29%29">begin-for-syntax</a></span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser-bound-vars</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Parsing_Syntax.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._syntax-parse%29%29">syntax-parse</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:datum-literals</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktSym">bind</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/stxparse-patterns.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._~7eor%29%29">~or</a></span><span class="hspace">&nbsp;</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">repeat</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/procedures.html#%28def._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._apply%29%29">apply</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._append%29%29">append</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._cons%29%29">cons</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._list%29%29">list</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28lib._racket%2Fprivate%2Fmap..rkt%29._map%29%29">map</a></span><span class="hspace">&nbsp;</span><span class="RktSym">parser-bound-vars</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/stxparse-specifying.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._attribute%29%29">attribute</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser-bound-vars</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._cons%29%29">cons</a></span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser-bound-vars</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._list%29%29">list</a></span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-syntax%29%29">define-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktSym">compile-parse-repeat</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Parsing_Syntax.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._syntax-parser%29%29">syntax-parser</a></span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29.__%29%29">_</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">on-fail</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Parsing_Syntax.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._define%2Fsyntax-parse%29%29">define/syntax-parse</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser-bound-vars</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Parsing_Syntax.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._define%2Fsyntax-parse%29%29">define/syntax-parse</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">iter-v</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stxops.html#%28def._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._generate-temporaries%29%29">generate-temporaries</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/stxparse-specifying.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._attribute%29%29">attribute</a></span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Parsing_Syntax.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._define%2Fsyntax-parse%29%29">define/syntax-parse</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p^</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin%29%29">begin</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/set_.html#%28form._%28%28quote._~23~25kernel%29._set%21%29%29">set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">iter-v</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._cons%29%29">cons</a></span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">iter-v</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">iter-v</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._list%29%29">list</a></span><span class="RktPn">)</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/match.html#%28form._%28%28lib._racket%2Fmatch..rkt%29._match-define%29%29">match-define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parse-result</span><span class="hspace">&nbsp;</span><span class="RktSym">overall-in</span><span class="hspace">&nbsp;</span><span class="RktSym">overall-result</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29">let</a></span><span class="hspace">&nbsp;</span><span class="RktSym">loop</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">compile-parse</span><span class="hspace">&nbsp;</span><span class="RktSym">p^</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^^</span><span class="hspace">&nbsp;</span><span class="RktSym">value</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">call-with-parse-result</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">loop</span><span class="hspace">&nbsp;</span><span class="RktSym">in^^</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in^^^</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/values.html#%28def._%28%28quote._~23~25kernel%29._values%29%29">values</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parse-result</span><span class="hspace">&nbsp;</span><span class="RktSym">in^^^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._cons%29%29">cons</a></span><span class="hspace">&nbsp;</span><span class="RktSym">value</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/values.html#%28def._%28%28quote._~23~25kernel%29._values%29%29">values</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/unreachable.html#%28def._%28%28quote._~23~25kernel%29._assert-unreachable%29%29">assert-unreachable</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parse-result</span><span class="hspace">&nbsp;</span><span class="RktSym">in^</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._list%29%29">list</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28lib._racket%2Fprivate%2Flist..rkt%29._reverse%29%29">reverse</a></span><span class="hspace">&nbsp;</span><span class="RktSym">iter-v</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">on-success</span><span class="hspace">&nbsp;</span><span class="RktSym">overall-in</span><span class="hspace">&nbsp;</span><span class="RktSym">overall-result</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr></tbody></table></div>

<p>We loop, running <span class="RktSym">p</span> as many times as we can. Each time, we take all of the values bound inside <span class="RktSym">p</span> and <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._cons%29%29">cons</a></span> them to a list that contains the values of that variable for each parse of <span class="RktSym">p</span>.</p>

<p>For example:</p>

<p></p>

<div class="SIntrapara">In
</div>

<div class="SIntrapara">
 <div class="SCodeFlow">
  <p><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">number-expr</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">","</span><span class="RktPn">)</span><span class="RktPn">)</span></p></div></div>

<div class="SIntrapara">the sub-parser becomes
</div>

<div class="SIntrapara">
 <div class="SCodeFlow">
  <table cellpadding="0" cellspacing="0" class="RktBlk">
   <tbody>
    <tr>
     <td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">number-expr</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">","</span><span class="RktPn">)</span></td></tr>
    <tr>
     <td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin%29%29">begin</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/set_.html#%28form._%28%28quote._~23~25kernel%29._set%21%29%29">set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">iter-n</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._cons%29%29">cons</a></span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">iter-n</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></div></div>

<div class="SIntrapara">and we run that parser for each iteration after initializing <span class="RktSym">iter-n</span> to an empty list before we start looping.</div>

<p>In the end, we reverse the lists because we built them up backwards, and then bind each variable to its corresponding list for outer use.</p>

<p>Now let&rsquo;s parse some strings!</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define-struct.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._struct%29%29">struct</a></span><span class="hspace">&nbsp;</span><span class="RktSym">addition</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">#:transparent</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define-struct.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._struct%29%29">struct</a></span><span class="hspace">&nbsp;</span><span class="RktSym">multiplication</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">#:transparent</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktSym">number-expr</span><span class="hspace">&nbsp;</span><span class="RktSym">addition-expr</span><span class="hspace">&nbsp;</span><span class="RktSym">multiplication-expr</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">number-expr</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">alt</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"1"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">text</span><span class="hspace">&nbsp;</span><span class="RktVal">"0"</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">addition-expr</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktVal">"("</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"+"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">")"</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">addition</span><span class="hspace">&nbsp;</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">multiplication-expr</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktVal">"("</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"*"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">")"</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">multiplication</span><span class="hspace">&nbsp;</span><span class="RktSym">left</span><span class="hspace">&nbsp;</span><span class="RktSym">right</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">parse</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#%28form._%28%28lib._syntax%2Fparse..rkt%29._expr%29%29">expr</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"((0+1)*(1+0))"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">(multiplication (addition 0 1) (addition 1 0))</span></p></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">array-expr</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktVal">"["</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">repeat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">number-expr</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">","</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">"]"</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">parse</span><span class="hspace">&nbsp;</span><span class="RktSym">array-expr</span><span class="hspace">&nbsp;</span><span class="RktVal">"[1,0,1,]"</span><span class="RktPn">)</span></td></tr>
   <tr>
    <td>
     <p><span class="RktRes">'(1 0 1)</span></p></td></tr></tbody></table></div>

<p>It is nice that we can define our own parsers and compose them, but there is a limitation with higher order parsers. For example:</p>

<div class="SCodeFlow">
 <table cellpadding="0" cellspacing="0" class="RktBlk">
  <tbody>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parenthesized</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktVal">"("</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktVal">")"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td>
     <table cellpadding="0" cellspacing="0" class="RktBlk">
      <tbody>
       <tr>
        <td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">parse</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._~3d~3e%29%29">=&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parenthesized</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">parser</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktVal">"foo"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr>
       <tr>
        <td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">"(foo)"</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr>
   <tr>
    <td>
     <p><span class="RktErr">x: undefined;</span></p></td></tr>
   <tr>
    <td>
     <p><span class="RktErr"></span><span class="hspace">&nbsp;</span><span class="RktErr">cannot reference an identifier before its definition</span></p></td></tr>
   <tr>
    <td>
     <p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">in module: top-level</span></p></td></tr></tbody></table></div>

<p>Since <span class="RktSym">parenthesized</span> is just a procedure call, our compiler can&rsquo;t go inside of it and see if variables are bound, so <span class="RktSym">x</span> winds up unbound.</p>

<p>If instead, <span class="RktSym">parenthesized</span> was some kind of parser macro, then it would work. But we&rsquo;d need our own custom DSL expander to support parser macros. There is a tool I&rsquo;m helping develop that will make it easy to do this, but that&rsquo;s a post for another day.</p>

<p>Either way, what we&rsquo;ve just made is very powerful. We can now write parsers for JSON and even most programming languages! And our parsers are composable, declarative, and have the full power of Racket. We created custom syntax for a parsing DSL that inter-operates with normal Racket code, which is something that isn&rsquo;t possible in most programming languages. This is a task where language-oriented programming comes in very handy.</p>
  <footer>
    <script type="text/javascript">
      !function(d,s,id){
          var js,fjs=d.getElementsByTagName(s)[0];
          if(!d.getElementById(id)){
              js=d.createElement(s);
              js.id=id;
              js.src="//platform.twitter.com/widgets.js";
              fjs.parentNode.insertBefore(js,fjs);
          }
      }(document,"script","twitter-wjs");
    </script>
    <a href="https://twitter.com/share"
       class="twitter-share-button"
       data-url="https://quasarbright.github.io/blog/2024/08/parsing-text-the-racket-way.html"
       data-dnt="true">
      "Tweet"</a>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.identifier = "/blog/2024/08/parsing-text-the-racket-way.html";
        this.page.url = "https://quasarbright.github.io/blog/2024/08/parsing-text-the-racket-way.html";
        this.page.title = "Parsing Text the Racket Way";
        this.page.category_id = undefined;
      };
      var disqus_shortname = 'quasarbright-github-io';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          dsq.setAttribute('data-timestamp', +new Date());
          (document.head || document.body).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <div class="row justify-content-center">
      <nav aria-label="Page Navigation">
        <ul class="pagination">
          <li class="page-item">
            <a class="page-link" href="/blog/2024/08/computing-fibonacci-numbers-in-logarithmic-time.html"
               aria-label="Previous">
              <span aria-hidden="true">&larr; Computing Fibonacci Numbers in Logarithmic Time</span>
            </a>
          </li>

        </ul>
      </nav>
    </div>
  </footer>
</article>
        </div>
      </div>
      <footer>
        <hr />
        <p>Site generated
        by <a href="https://github.com/greghendershott/frog">Frog</a>,
        the <strong>fr</strong>ozen bl<strong>og</strong> tool.</p>
        <p><a href="https://github.com/quasarbright/blog">Blog source code</a></p>
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
      </footer>
    </div>
    <!-- </body> JS -->
    <script type="text/javascript" src="/blog/js/jquery-3.2.1.slim.min.js"></script>
    <script type="text/javascript" src="/blog/js/bootstrap.bundle.min.js"></script>
  </body>
</html>